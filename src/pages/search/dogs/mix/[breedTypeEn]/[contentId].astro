---
import Layout from '../../../../../layouts/Layout.astro';
import LineInquiryModal from '../../../../../components/LineInquiryModal.astro';
import { getLatestPetsByType } from '../../../../../lib/api/pets/queries';
import { getBreedsByAnimalType } from '../../../../../lib/api/pets';
import { getStoreById } from '../../../../../lib/api/stores';
import { getVoices } from '../../../../../lib/api/voice';
import { getImageUrl } from '../../../../../lib/utils/image';
import { formatDate } from '../../../../../lib/utils/date';
import BaseButton from '../../../../../components/ui/buttons/BaseButton.astro';
import ButtonWrapper from '../../../../../components/ui/buttons/ButtonWrapper.astro';
import VoiceCard from '../../../../../components/voice/VoiceCard.astro';
import BannerSection from '../../../../../components/sections/common/BannerSection.astro';
import ContactCTASection from '../../../../../components/sections/common/ContactCTASection.astro';
import Breadcrumb from '../../../../../components/ui/Breadcrumb.astro';
import '../../../../../styles/layout/pets-grid.scss';
import '../../../../../components/pets/PetCard.scss';
import '../../../../../styles/pages/pet-detail.scss';

export async function getStaticPaths() {
  try {
    const allDogs = await getLatestPetsByType('dog');
    console.log('[getStaticPaths] å…¨çŠ¬ãƒ‡ãƒ¼ã‚¿æ•°:', allDogs.length);
    console.log('[getStaticPaths] æœ€åˆã®5åŒ¹ã®çŠ¬ã®åˆ†é¡:', allDogs.slice(0, 5).map(p => ({ id: p.id, classification: p.classification, breedTypeJa: p.breedTypeJa })));
    
    const mixDogs = allDogs.filter(pet => pet.classification === 'mix');
    console.log('[getStaticPaths] ãƒŸãƒƒã‚¯ã‚¹çŠ¬ã®æ•°:', mixDogs.length);
    
    if (mixDogs.length === 0) {
      console.log('[getStaticPaths] ãƒŸãƒƒã‚¯ã‚¹çŠ¬ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
      // ãƒŸãƒƒã‚¯ã‚¹çŠ¬ãŒãªã„å ´åˆã§ã‚‚å…¨ã¦ã®çŠ¬ã§è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
      const allValidDogs = allDogs.filter(pet => pet.breedTypeEn && pet.id);
      console.log('[getStaticPaths] å…¨çŠ¬ã§è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ:', allValidDogs.length);
      
      const paths = allValidDogs.map((pet) => ({
        params: { 
          breedTypeEn: pet.breedTypeEn.toLowerCase(),
          contentId: pet.id
        }
      }));
      
      return paths;
    }
    
    const paths = mixDogs
      .filter(pet => pet.breedTypeEn && pet.id) // breedTypeEnã¨idãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘
      .map((pet) => ({
        params: { 
          breedTypeEn: pet.breedTypeEn.toLowerCase(),
          contentId: pet.id
        }
      }));
    
    console.log('[getStaticPaths] ç”Ÿæˆã•ã‚Œã‚‹ãƒŸãƒƒã‚¯ã‚¹çŠ¬è©³ç´°ãƒšãƒ¼ã‚¸æ•°:', paths.length);
    console.log('[getStaticPaths] æœ€åˆã®5ã¤ã®ãƒ‘ã‚¹:', paths.slice(0, 5));
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒšãƒƒãƒˆã®è©³ç´°ã‚’è¡¨ç¤º
    console.log('[getStaticPaths] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒšãƒƒãƒˆæ•°:', mixDogs.length);
    console.log('[getStaticPaths] æœ€åˆã®5åŒ¹ã®ãƒšãƒƒãƒˆ:', mixDogs.slice(0, 5).map(p => ({ id: p.id, breedTypeEn: p.breedTypeEn, breedTypeJa: p.breedTypeJa })));
    
    return paths;
  } catch (error) {
    console.error('[getStaticPaths] ãƒŸãƒƒã‚¯ã‚¹çŠ¬è©³ç´°ãƒšãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

const { breedTypeEn, contentId } = Astro.params;

console.log('=== ãƒŸãƒƒã‚¯ã‚¹çŠ¬è©³ç´°ãƒšãƒ¼ã‚¸é–‹å§‹ ===');
console.log('breedTypeEn:', breedTypeEn);
console.log('contentId:', contentId);

// ãƒšãƒƒãƒˆè©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const allDogs = await getLatestPetsByType('dog');
console.log('[ãƒšãƒƒãƒˆè©³ç´°] å…¨çŠ¬ãƒ‡ãƒ¼ã‚¿æ•°:', allDogs.length);
const pet = allDogs.find(p => p.id === contentId && p.breedTypeEn?.toLowerCase() === breedTypeEn?.toLowerCase());

if (!pet) {
  console.error(`Pet not found: ${contentId}, breedTypeEn: ${breedTypeEn}`);
  console.log('Available ids:', allDogs.map(p => p.id).slice(0, 10));
  console.log('Available breedTypeEns:', [...new Set(allDogs.map(p => p.breedTypeEn))]);
  return new Response('Pet not found', { status: 404 });
}

console.log('è¦‹ã¤ã‹ã£ãŸãƒšãƒƒãƒˆ:', pet.breedTypeJa, pet.id);

// å“ç¨®åã‚’å–å¾—ï¼ˆæ—¥æœ¬èªï¼‰
const { pureBreeds } = await getBreedsByAnimalType('dog');
const breedData = pureBreeds.find(breed => breed.url.split('/').pop() === breedTypeEn);
const breedTypeJa = breedData ? breedData.name : pet.breedTypeJa;

// åº—èˆ—æƒ…å ±ã‚’å–å¾—ï¼ˆIDã§å–å¾—ã€å¤±æ•—ã—ãŸå ´åˆã¯åå‰ã§æ¤œç´¢ï¼‰
let storeInfo = await getStoreById(pet.storeId);

// IDã§å–å¾—ã§ããªã„å ´åˆã¯ã€å…¨åº—èˆ—ã‹ã‚‰åå‰ã§æ¤œç´¢
if (!storeInfo) {
  const { getAllStores } = await import('../../../../../lib/api/stores');
  const allStores = await getAllStores();
  storeInfo = allStores.find(store => store.storeName === pet.storeName);
}

console.log('=== åº—èˆ—æƒ…å ±ãƒ‡ãƒãƒƒã‚° ===');
console.log('pet.storeId:', pet.storeId);
console.log('pet.storeName:', pet.storeName);
console.log('å–å¾—ã—ãŸåº—èˆ—æƒ…å ±:', storeInfo);
console.log('storeLine:', storeInfo?.storeLine);

// ç”»åƒãƒ»å‹•ç”»URLã‚’æº–å‚™
const mediaItems = [];
const placeholderImage = '/images/ui/img_loading-pet-image-01.webp';

// 4ã¤ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å›ºå®šã§ç”¨æ„
const mediaSlots = [
  { url: pet.imageUrl01, type: 'image', label: 'å†™çœŸ1' },
  { url: pet.imageUrl02, type: 'image', label: 'å†™çœŸ2' },
  { url: pet.imageUrl03, type: 'image', label: 'å†™çœŸ3' },
  { url: pet.videoUrl, type: 'video', label: 'å‹•ç”»' }
];

mediaSlots.forEach((slot, index) => {
  if (slot.url) {
    if (slot.type === 'image') {
      mediaItems.push({
        type: 'image',
        url: getImageUrl(slot.url, 800, 600),
        thumbnail: getImageUrl(slot.url, 150, 150),
        alt: `${pet.breedTypeJa}ã®${slot.label}`
      });
    } else if (slot.type === 'video') {
      // microCMSã®å‹•ç”»URLã‚’ãã®ã¾ã¾ä½¿ç”¨
      const videoThumbnail = getImageUrl(slot.url, 150, 150);
      
      mediaItems.push({
        type: 'video',
        url: slot.url,
        thumbnail: videoThumbnail,
        alt: `${pet.breedTypeJa}ã®${slot.label}`
      });
    }
  } else {
    // ç©ºã®ã‚¹ãƒ­ãƒƒãƒˆã«ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’ä½¿ç”¨
    mediaItems.push({
      type: 'image', // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯å¸¸ã«ç”»åƒã¨ã—ã¦æ‰±ã†
      url: placeholderImage,
      thumbnail: placeholderImage,
      alt: `${pet.breedTypeJa}ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒ${index + 1}`,
      isPlaceholder: true,
      isVideoPlaceholder: slot.type === 'video' // å‹•ç”»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ•ãƒ©ã‚°
    });
  }
});

console.log('ãƒ¡ãƒ‡ã‚£ã‚¢é …ç›®æ•°:', mediaItems.length);

// ã‚ªã‚¹ã‚¹ãƒ¡ãƒšãƒƒãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRecommendedPets(currentPet: any, allPets: any[], count: number = 3) {
  // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
  const otherPets = allPets.filter(p => p.id !== currentPet.id);
  
  // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°
  const scoreCalculator = (pet: any) => {
    let score = 0;
    
    // 1. å…±é€šã®ã‚¿ã‚°ï¼ˆæœ€é«˜å„ªå…ˆåº¦ï¼‰
    if (currentPet.tags && pet.tags) {
      // ã‚¿ã‚°ãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
      const currentTags = Array.isArray(currentPet.tags) ? currentPet.tags : [currentPet.tags];
      const petTags = Array.isArray(pet.tags) ? pet.tags : [pet.tags];
      const commonTags = currentTags.filter((tag: string) => petTags.includes(tag));
      score += commonTags.length * 100; // ã‚¿ã‚°ä¸€è‡´ã¯é«˜å¾—ç‚¹
    }
    
    // 2. èª•ç”Ÿæ—¥ã®è¿‘ã•ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
    if (currentPet.birthday && pet.birthday) {
      const currentDate = new Date(currentPet.birthday);
      const petDate = new Date(pet.birthday);
      const daysDiff = Math.abs((currentDate.getTime() - petDate.getTime()) / (1000 * 3600 * 24));
      
      if (daysDiff <= 30) {
        score += 50; // 30æ—¥ä»¥å†…ã¯é«˜å¾—ç‚¹
      } else if (daysDiff <= 90) {
        score += 25; // 90æ—¥ä»¥å†…ã¯ä¸­å¾—ç‚¹
      } else if (daysDiff <= 180) {
        score += 10; // 180æ—¥ä»¥å†…ã¯ä½å¾—ç‚¹
      }
    }
    
    // 3. åŒã˜æ€§åˆ¥ï¼ˆä½å„ªå…ˆåº¦ï¼‰
    if (currentPet.gender === pet.gender) {
      score += 15;
    }
    
    return score;
  };
  
  // ã‚¹ã‚³ã‚¢ä»˜ãã§ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½ã‚’å–å¾—
  return otherPets
    .map(pet => ({ ...pet, score: scoreCalculator(pet) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, count);
}

// ç¾åœ¨ã®ãƒšãƒƒãƒˆã¨åŒã˜å‹•ç‰©ç¨®ã®ãƒšãƒƒãƒˆã‚’ã™ã¹ã¦å–å¾—
const allSameTypePets = await getLatestPetsByType(pet.animalType);
const allRecommendedPets = getRecommendedPets(pet, allSameTypePets, 3);

// ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç”¨ã«åˆ†å‰²ï¼ˆlgæœªæº€ã¯2åŒ¹ã€lgä»¥é™ã¯3åŒ¹ï¼‰
const recommendedPetsMobile = allRecommendedPets.slice(0, 2);
const recommendedPetsDesktop = allRecommendedPets;

console.log('ã‚ªã‚¹ã‚¹ãƒ¡ãƒšãƒƒãƒˆ:', allRecommendedPets.map(p => ({ id: p.id, score: p.score, breedTypeJa: p.breedTypeJa })));

// ãŠå®¢æ§˜ã®å£°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const allVoices = await getVoices(10); // å¤šã‚ã«å–å¾—ã—ã¦ãŠã
const displayVoices = allVoices.slice(0, 2); // smä»¥é™ã§æœ€å¤§2ä»¶è¡¨ç¤º

console.log('ãŠå®¢æ§˜ã®å£°ãƒ‡ãƒ¼ã‚¿:', displayVoices.length, 'ä»¶å–å¾—');

// ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿
const breadcrumbItems = [
  { label: 'ãƒ›ãƒ¼ãƒ ', href: '/' },
  { label: 'å­çŠ¬ãƒ»å­çŒ«ã‚’æ¢ã™', href: '/search' },
  { label: 'å­çŠ¬ã‚’æ¢ã™', href: '/search/dogs' },
];

// ãƒŸãƒƒã‚¯ã‚¹çŠ¬ã®å ´åˆã¯ãƒŸãƒƒã‚¯ã‚¹ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
if (pet.classification === 'mix') {
  breadcrumbItems.push(
    { label: 'ãƒŸãƒƒã‚¯ã‚¹', href: '/search/dogs/mix' },
    { label: breedTypeJa, href: `/search/dogs/mix/${breedTypeEn}` }
  );
} else {
  breadcrumbItems.push(
    { label: breedTypeJa, href: `/search/dogs/${breedTypeEn}` }
  );
}

// æœ€å¾Œã«å€‹ä½“æƒ…å ±ã‚’è¿½åŠ 
breadcrumbItems.push({ label: `ãƒšãƒƒãƒˆè©³ç´°ï¼ˆ${pet.id.replace(/^0+/, '') || pet.id}ï¼‰` });
---

<Layout 
  title={`${pet.breedTypeJa}ï¼ˆ${pet.gender}ï¼‰ï½œCattleya ${pet.storeName}ï½œå­çŠ¬è©³ç´°`}
  description={`No.${pet.id.replace(/^0+/, '') || pet.id}ã€èª•ç”Ÿæ—¥ï¼š${formatDate(pet.birthday)}ã€ã‚«ãƒ©ãƒ¼ï¼š${pet.color}ã€‚`}
  ogImage={pet.imageUrl01 ? getImageUrl(pet.imageUrl01, 1200, 630) : '/og-image.png'}
>
  <main>
    <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
    <div class="breadcrumb-container">
      <div class="container">
        <Breadcrumb items={breadcrumbItems} />
      </div>
    </div>
    
    <section class="pet-detail">
      <div class="container">
        <div class="pet-detail__content">
          <!-- ãƒšãƒƒãƒˆåã¨æ€§åˆ¥ -->
          <div class="pet-detail__header">
            <h1 class="pet-detail__title">
              {breedTypeJa}
            </h1>
          </div>

          <div class="pet-detail__body">
            <!-- ã‚«ãƒ«ãƒ¼ã‚»ãƒ« -->
            <div class="pet-detail__carousel">
              <div class="carousel">
                <div class="carousel__main">
                  <button class="carousel__nav carousel__nav--prev" id="prevBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  
                  <div class="carousel__container" id="carousel-container">
                    {mediaItems.map((item, index) => (
                      <div 
                        class={`carousel__slide ${index === 0 ? 'carousel__slide--active' : ''}`}
                        data-index={index}
                      >
                        {item.type === 'image' && !item.isVideoPlaceholder ? (
                          <img 
                            src={item.url}
                            alt={item.alt}
                            class="carousel__image"
                            loading={index === 0 ? 'eager' : 'lazy'}
                          />
                        ) : item.type === 'image' && item.isVideoPlaceholder ? (
                          <!-- å‹•ç”»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆno-image + ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ -->
                          <div class="carousel__video-container carousel__video-container--placeholder">
                            <img 
                              src={item.url}
                              alt={item.alt}
                              class="carousel__image"
                              loading={index === 0 ? 'eager' : 'lazy'}
                            />
                            <div class="carousel__video-message">
                              <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32" class="video-message-icon">
                                <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                              </svg>
                              <p class="video-message-text">å‹•ç”»ãŒè¨­å®šã•ã‚Œã¦<br>ã„ã¾ã›ã‚“</p>
                            </div>
                          </div>
                        ) : (
                          <!-- å®Ÿéš›ã®å‹•ç”» -->
                          <div class="carousel__video-container">
                            <video
                              class="carousel__video"
                              data-video-src={item.url}
                              preload="metadata"
                              muted
                              playsInline
                            ></video>
                            <div class="carousel__video-play-btn">
                              <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                                <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                              </svg>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>

                  <button class="carousel__nav carousel__nav--next" id="nextBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>

                <!-- ã‚µãƒ ãƒã‚¤ãƒ« -->
                <div class="carousel__thumbnails">
                  {mediaItems.map((item, index) => (
                    <button 
                      class={`carousel__thumbnail ${index === 0 ? 'carousel__thumbnail--active' : ''}`}
                      data-index={index}
                    >
                      {item.type === 'image' && !item.isVideoPlaceholder ? (
                        <img 
                          src={item.thumbnail}
                          alt={item.alt}
                          class="carousel__thumbnail-image"
                        />
                      ) : item.type === 'image' && item.isVideoPlaceholder ? (
                        <!-- å‹•ç”»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆno-image + ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ -->
                        <div class="carousel__thumbnail-video carousel__thumbnail-video--placeholder">
                          <img 
                            src={item.thumbnail}
                            alt={item.alt}
                            class="carousel__thumbnail-image"
                          />
                          <div class="carousel__thumbnail-message">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" class="thumbnail-message-icon">
                              <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                            </svg>
                            <span class="thumbnail-message-text">å‹•ç”»ãªã—</span>
                          </div>
                        </div>
                      ) : (
                        <!-- å®Ÿéš›ã®å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ« -->
                        <div class="carousel__thumbnail-video">
                          <video
                            class="carousel__thumbnail-video-element"
                            data-video-src={item.url}
                            preload="metadata"
                            muted
                            playsInline
                          ></video>
                          <div class="carousel__thumbnail-play-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                              <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                            </svg>
                          </div>
                        </div>
                      )}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒšãƒƒãƒˆæƒ…å ± + ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ -->
            <div class="pet-detail__sidebar">
              <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆlgä»¥ä¸Šã§è¡¨ç¤ºï¼‰ -->
              <div class="pet-detail__sidebar-title">
                <h1 class="pet-detail__title">
                  {breedTypeJa}
                </h1>
              </div>

              <!-- ãƒšãƒƒãƒˆæƒ…å ± -->
              <div class="pet-detail__info">
                <div class="pet-info">
                  <div class="pet-info__item">
                    <dt class="pet-info__label">æ€§åˆ¥</dt>
                    <dd class="pet-info__value">{pet.gender}</dd>
                  </div>
                  <div class="pet-info__item">
                    <dt class="pet-info__label">ã‚«ãƒ©ãƒ¼</dt>
                    <dd class="pet-info__value">{pet.color}</dd>
                  </div>
                  <div class="pet-info__item">
                    <dt class="pet-info__label">èª•ç”Ÿæ—¥</dt>
                    <dd class="pet-info__value">{formatDate(pet.birthday)}</dd>
                  </div>
                  {(pet.mixFatherBreed || pet.mixMotherBreed) && (
                    <div class="pet-info__item">
                      <dt class="pet-info__label">ä¸¡è¦ªæƒ…å ±</dt>
                      <dd class="pet-info__value pet-info__value--parents">
                        {pet.mixFatherBreed && <span class="parent-info">çˆ¶ï¼š{pet.mixFatherBreed}</span>}
                        {pet.mixMotherBreed && <span class="parent-info">æ¯ï¼š{pet.mixMotherBreed}</span>}
                      </dd>
                    </div>
                  )}
                  {(pet.fatherWeight || pet.motherWeight) && (
                    <div class="pet-info__item">
                      <dt class="pet-info__label">ä¸¡è¦ªä½“é‡</dt>
                      <dd class="pet-info__value pet-info__value--parents">
                        {pet.fatherWeight && <span class="parent-info">çˆ¶ï¼š{pet.fatherWeight}kg</span>}
                        {pet.motherWeight && <span class="parent-info">æ¯ï¼š{pet.motherWeight}kg</span>}
                      </dd>
                    </div>
                  )}
                  <div class="pet-info__item">
                    <dt class="pet-info__label">ãŠå•ã„åˆã‚ã›ç•ªå·</dt>
                    <dd class="pet-info__value">{pet.id.replace(/^0+/, '') || pet.id}</dd>
                  </div>
                  <div class="pet-info__item">
                    <dt class="pet-info__label">åº—èˆ—</dt>
                    <dd class="pet-info__value">
                      <a href={`/stores/${pet.storeId}`} class="store-tag">
                        #{pet.storeName}
                      </a>
                    </dd>
                  </div>
                </div>
              </div>

              <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
              <div class="pet-detail__actions">
                <div class="action-buttons">
                  <button 
                    type="button"
                    class="action-button action-button--link"
                    onclick="openLineInquiryModal()"
                  >
                    <div class="action-button__icon">
                      <img src="/icons/icon_line-01.svg" alt="LINEã‚¢ã‚¤ã‚³ãƒ³" width="32" height="32" />
                    </div>
                    <div class="action-button__text">
                      ã“ã®å­ã‚’LINEã§<br>å•ã„åˆã‚ã›ã‚‹
                    </div>
                  </button>

                  <a 
                    href={`/contact?pet=${pet.id}#inquiry-number-label`}
                    class="action-button action-button--mail"
                  >
                    <div class="action-button__icon">
                      <img src="/icons/icon_store-mail-01.svg" alt="ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³" width="32" height="32" />
                    </div>
                    <div class="action-button__text">
                      ã“ã®å­ã‚’ãƒ¡ãƒ¼ãƒ«ã§<br>å•ã„åˆã‚ã›ã‚‹
                    </div>
                  </a>

                  <button class="action-button action-button--phone">
                    <div class="action-button__icon">
                      <img src="/icons/icon_store-phone-01.svg" alt="é›»è©±ã‚¢ã‚¤ã‚³ãƒ³" width="32" height="32" />
                    </div>
                    <div class="action-button__text">
                      ã“ã®å­ã‚’é›»è©±ã§<br>å•ã„åˆã‚ã›ã‚‹
                    </div>
                  </button>
                </div>
              </div>

              <!-- ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
              <div class="pet-detail__share">
                <div class="share-header">
                  ï¼¼ã“ã®å­ã‚’ã¿ã‚“ãªã«ã‚·ã‚§ã‚¢ã™ã‚‹ï¼
                </div>
                <div class="share-buttons">
                  <button class="share-button share-button--twitter">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                      <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                  </button>
                  <button class="share-button share-button--line">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                      <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                    </svg>
                  </button>
                  <button class="share-button share-button--link">
                    <img src="/icons/icon_chain-01.svg" alt="ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼" width="20" height="20" />
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- é–¢é€£ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="related-content-section">
      <div class="container">
        <!-- ã“ã®å­ã«ä¼šã„ãŸã„ãƒœãƒƒã‚¯ã‚¹ -->
        <div class="content-box">
          <h2 class="content-box__title">ã“ã®å­ã«ä¼šã„ãŸã„</h2>
          <div class="content-box__buttons">
            <a href="/flow" class="bg-button bg-button--flow">
              <div class="bg-button__overlay">
                <span class="bg-button__text">ãŠè¿ãˆã¾ã§ã®æµã‚Œ</span>
              </div>
            </a>
            <a href="/reserve" class="bg-button bg-button--reserve">
              <div class="bg-button__overlay">
                <span class="bg-button__text">æ¥åº—äºˆç´„ã‚’ã™ã‚‹</span>
              </div>
            </a>
          </div>
        </div>

        <!-- ã‚ãªãŸã¸ã®ã‚ªã‚¹ã‚¹ãƒ¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="content-box">
          <h2 class="content-box__title">ã‚ãªãŸã¸ã®ã‚ªã‚¹ã‚¹ãƒ¡</h2>
          <div class="pets-grid">
            {allRecommendedPets.map((recommendedPet, index) => (
              <div class={`pet-card ${index >= 2 ? 'pet-card--lg-only' : ''}`} data-animal-type={recommendedPet.animalType}>
                <a href={`/search/${pet.animalType === 'dog' ? 'dogs' : 'cats'}/${recommendedPet.classification === 'mix' ? 'mix/' : ''}${encodeURIComponent((recommendedPet.breedTypeEn || '').toLowerCase())}/${recommendedPet.id}`} class="pet-card__link">
                  <div class="pet-card__inner">
                    <div class="pet-card__image-container">
                      <img
                        class="pet-card__image"
                        src={getImageUrl(recommendedPet.imageUrl01, 600, 600)}
                        alt={`${recommendedPet.breedTypeJa}ã®å†™çœŸ`}
                        loading="lazy"
                        width="600"
                        height="600"
                        onerror="this.src='/images/ui/img_loading-pet-image-01.webp'"
                      />
                    </div>
                    <div class="pet-card__info">
                      <h3 class="pet-card__title">
                        {recommendedPet.breedTypeJa}
                        {recommendedPet.gender === 'ç”·ã®å­' && (
                          <img class="pet-card__gender male" src="/icons/icon_male.png" alt="ç”·ã®å­" />
                        )}
                        {recommendedPet.gender === 'å¥³ã®å­' && (
                          <img class="pet-card__gender female" src="/icons/icon_female.png" alt="å¥³ã®å­" />
                        )}
                      </h3>
                      <div class="pet-card__details">
                        <p class="pet-card__detail-item">ã‚«ãƒ©ãƒ¼ï¼š{recommendedPet.color}</p>
                        <p class="pet-card__detail-item">èª•ç”Ÿæ—¥ï¼š{formatDate(recommendedPet.birthday)}</p>
                        <p class="pet-card__detail-item">åº—èˆ—ï¼š{recommendedPet.storeName}</p>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            ))}
          </div>
        </div>

        <!-- ãƒ›ãƒ¼ãƒ ã‚¹ãƒ†ã‚¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="content-box homestay-content-box">
          <h2 class="content-box__title">ãƒ›ãƒ¼ãƒ ã‚¹ãƒ†ã‚¤</h2>
          <div class="homestay-section-inner">
            <div class="homestay-img-wrap">
              <img src="/images/content/img_homestay_main-01.webp" alt="ãƒ›ãƒ¼ãƒ ã‚¹ãƒ†ã‚¤" class="homestay-img" loading="lazy" />
            </div>
            
            <div class="homestay-content">
              <div class="homestay-features">
                <p class="homestay-feature">ä¸€å¾‹10,000å††(ç¨è¾¼)ã§é¸ã¹ã‚‹æ³Šæ•°</p>
                <p class="homestay-feature">ãŠæ³Šã¾ã‚Šã‚»ãƒƒãƒˆç„¡æ–™ã§ãƒ¬ãƒ³ã‚¿ãƒ«</p>
              </div>
              <p class="homestay-desc">ã‚«ãƒˆãƒ¬ã‚¢ã§ã¯ã€ãŠå®¢æ§˜ã¨ãƒ¯ãƒ³ã¡ã‚ƒã‚“ãƒ»ãƒã‚³ã¡ã‚ƒã‚“ã®ç›¸æ€§ã‚„é£¼è‚²ä¸å®‰ã‚’å–ã‚Šé™¤ããŸã‚ã«ã€ãƒ›ãƒ¼ãƒ ã‚¹ãƒ†ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚<br><br>ãƒ›ãƒ¼ãƒ ã‚¹ãƒ†ã‚¤ä¸­ã‚‚ã‚¹ã‚¿ãƒƒãƒ•ãŒç²¾ä¸€æ¯ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚<br>ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚</p>
              <ButtonWrapper>
                <BaseButton href="/homestay" text="è©³ã—ãã¿ã‚‹" variant="short" />
              </ButtonWrapper>
            </div>
          </div>
        </div>

        <!-- ãŠå®¢æ§˜ã®å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="content-box voice-content-box">
          <h2 class="content-box__title">ãŠå®¢æ§˜ã®å£°</h2>
          <div class="voice-grid">
            {displayVoices.map((voice, index) => (
              <div class={`voice-card-wrapper ${index >= 1 ? 'voice-card--sm-only' : ''}`}>
                <VoiceCard
                  petName={voice.petName}
                  petGender={voice.petGender}
                  petThumbnail={voice.petThumbnail}
                  ownerName={voice.ownerName}
                  animalType={voice.animalType}
                  store={voice.store}
                  voiceContent={voice.voiceContent}
                  class="voice-card--compact"
                />
              </div>
            ))}
          </div>
          <ButtonWrapper>
            <BaseButton href="/voice" text="ã‚‚ã£ã¨ã¿ã‚‹" variant="short" />
          </ButtonWrapper>
        </div>

        <!-- ã‚«ãƒˆãƒ¬ã‚¢ã®å®‰å¿ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="content-box relief-content-box">
          <h2 class="content-box__title">ã‚«ãƒˆãƒ¬ã‚¢ã®å®‰å¿ƒ</h2>
          <div class="relief-section-inner">
            <div class="relief-img-wrap">
              <img src="/images/content/img_relief-main-01.webp" alt="ã‚«ãƒˆãƒ¬ã‚¢ã®å®‰å¿ƒ" class="relief-img" loading="lazy" />
            </div>
            
            <div class="relief-content">
              <p class="relief-desc">ã‚«ãƒˆãƒ¬ã‚¢ã§ã¯ã€å°‚é–€ç£åŒ»å¸«ã«ã‚ˆã‚‹å¾¹åº•ã—ãŸå¥åº·ç®¡ç†ã‚„ã€ä¸‡ãŒä¸€ã®äº‹æ…‹ã«å‚™ãˆãŸä¿è¨¼ã€ãã—ã¦ãŠè¿ãˆå¾Œã‚‚ç¶šãã‚µãƒãƒ¼ãƒˆã‚’é€šã˜ã¦ã€ãƒšãƒƒãƒˆã¨ãŠå®¢æ§˜ãŒå®‰å¿ƒã—ã¦éã”ã›ã‚‹ç’°å¢ƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚<br>å¥åº·çŠ¶æ…‹ã®è©³ç´°ãªæƒ…å ±æä¾›ã‚„ã€æ¸…æ½”ãªç’°å¢ƒã§ã®é£¼è‚²ã‚‚å¿ƒãŒã‘ã¦ã„ã¾ã™ã€‚<br><br>ãƒšãƒƒãƒˆã¨å®¶æ—ãŒä¸€ç”Ÿæ¶¯å®‰å¿ƒã—ã¦ä¸€ç·’ã«éã”ã›ã‚‹ã‚ˆã†ã€å…¨ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚µãƒãƒ¼ãƒˆã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚</p>
              <ButtonWrapper>
                <BaseButton href="/relief" text="è©³ã—ãã¿ã‚‹" variant="short" />
              </ButtonWrapper>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ãƒãƒŠãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <BannerSection />

    <!-- ãŠå•ã„åˆã‚ã›CTAã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <ContactCTASection />

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="media-modal" class="media-modal">
      <div class="media-modal__overlay"></div>
      <div class="media-modal__content">
        <button class="media-modal__close" id="modal-close">
          <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
        
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <button class="media-modal__nav media-modal__nav--prev" id="modal-prev">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <button class="media-modal__nav media-modal__nav--next" id="modal-next">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
        
        <div class="media-modal__media" id="modal-media">
          <!-- ãƒ¡ãƒ‡ã‚£ã‚¢å†…å®¹ãŒJavaScriptã§å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>
      </div>
    </div>
  </main>

  <!-- LINEãŠå•ã„åˆã‚ã›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <LineInquiryModal petId={pet.id} storeLine={storeInfo?.storeLine} />
</Layout>

<script define:vars={{ mediaItemsCount: mediaItems.length, mediaItems }}>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Pet detail page initialized with HTML5 video support');
    
    let currentSlide = 0;
    let currentModalSlide = 0; // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const modal = document.getElementById('media-modal');
    const modalMedia = document.getElementById('modal-media');
    const modalClose = document.getElementById('modal-close');
    const modalOverlay = modal ? modal.querySelector('.media-modal__overlay') : null;
    const modalPrev = document.getElementById('modal-prev');
    const modalNext = document.getElementById('modal-next');
    
    // ã‚«ãƒ«ãƒ¼ã‚»ãƒ«é–¢é€£
    const slides = document.querySelectorAll('.carousel__slide');
    const thumbnails = document.querySelectorAll('.carousel__thumbnail');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    console.log(`ğŸ¯ Found ${slides.length} slides, ${thumbnails.length} thumbnails`);

    function openModal(mediaItem, slideIndex = currentSlide) {
      console.log('ğŸ¬ Opening modal with HTML5 video:', mediaItem);
      
      // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¨­å®š
      currentModalSlide = slideIndex;
      updateModalNavButtons();
      
      // ãƒ¡ãƒ‡ã‚£ã‚¢å†…å®¹ã‚’ã‚¯ãƒªã‚¢
      modalMedia.innerHTML = '';
      
      if (mediaItem.type === 'image' && !mediaItem.isVideoPlaceholder) {
        const img = document.createElement('img');
        img.src = mediaItem.url;
        img.alt = mediaItem.alt;
        img.className = 'media-modal__image';
        modalMedia.appendChild(img);
        console.log('ğŸ–¼ï¸ Image added to modal');
      } else if (mediaItem.type === 'image' && mediaItem.isVideoPlaceholder) {
        // å‹•ç”»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const messageContainer = document.createElement('div');
        messageContainer.className = 'media-modal__video-message';
        messageContainer.innerHTML = `
          <div class="modal-video-message">
            <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48" class="modal-message-icon">
              <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
            </svg>
            <p class="modal-message-text">å‹•ç”»ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          </div>
        `;
        modalMedia.appendChild(messageContainer);
        console.log('ğŸ“¹ Video placeholder message added to modal');
      } else if (mediaItem.type === 'video') {
        // HTML5 videoè¦ç´ ã‚’ä½œæˆ
        const video = document.createElement('video');
        
        let videoUrl = mediaItem.url;
        
        video.src = videoUrl;
        video.controls = true;
        video.autoplay = true;
        video.muted = false;
        video.preload = 'metadata';
        video.playsInline = true;
        
        // å‹•ç”»ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’æ¤œå‡ºã—ã¦CSSã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
        const urlLower = mediaItem.url.toLowerCase();
        let videoClass = 'media-modal__video';
        
        if (urlLower.includes('vertical') || 
            urlLower.includes('portrait') || 
            urlLower.includes('9-16') ||
            urlLower.includes('916') ||
            urlLower.includes('tiktok') ||
            urlLower.includes('story')) {
          videoClass += ' vertical-video';
          console.log('ğŸ¬ Applied vertical-video class');
        } else if (urlLower.includes('square') || 
                   urlLower.includes('1-1') ||
                   urlLower.includes('11') ||
                   urlLower.includes('instagram')) {
          videoClass += ' square-video';
          console.log('ğŸ¬ Applied square-video class');
        } else {
          console.log('ğŸ¬ Applied default horizontal video class');
        }
        
        video.className = videoClass;
        
        // å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        video.addEventListener('loadedmetadata', () => {
          console.log('ğŸ¬ Video metadata loaded:', {
            videoWidth: video.videoWidth,
            videoHeight: video.videoHeight,
            duration: video.duration,
            aspectRatio: video.videoWidth / video.videoHeight
          });
          
          // å®Ÿéš›ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«åŸºã¥ã„ã¦ã‚¯ãƒ©ã‚¹ã‚’å†èª¿æ•´
          const actualAspectRatio = video.videoWidth / video.videoHeight;
          video.classList.remove('vertical-video', 'square-video');
          
          if (actualAspectRatio < 1) {
            video.classList.add('vertical-video');
            console.log('ğŸ¬ Updated to vertical-video based on actual dimensions');
          } else if (Math.abs(actualAspectRatio - 1) < 0.1) {
            video.classList.add('square-video');
            console.log('ğŸ¬ Updated to square-video based on actual dimensions');
          } else {
            console.log('ğŸ¬ Using default horizontal layout based on actual dimensions');
          }
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        video.addEventListener('error', (e) => {
          console.error('ğŸ¬ Video playback error:', e);
        });
        
        modalMedia.appendChild(video);
        console.log('ğŸ¬ HTML5 video added to modal');
      }
      
      modal.classList.add('media-modal--active');
      document.body.style.overflow = 'hidden';
      console.log('âœ… Modal opened with HTML5 video support');
    }

    function closeModal() {
      modal.classList.remove('media-modal--active');
      document.body.style.overflow = '';
      modalMedia.innerHTML = '';
      console.log('âŒ Modal closed');
    }

    function updateModalNavButtons() {
      // å¾ªç’°ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚å¸¸ã«æœ‰åŠ¹ã«ã™ã‚‹
      if (modalPrev) {
        modalPrev.disabled = false;
      }
      if (modalNext) {
        modalNext.disabled = false;
      }
    }

    function showModalSlide(index) {
      // å¾ªç’°å‡¦ç†ã‚’è¿½åŠ 
      const normalizedIndex = (index + mediaItemsCount) % mediaItemsCount;
      
      const mediaItem = mediaItems[normalizedIndex];
      if (mediaItem) {
        openModal(mediaItem, normalizedIndex);
        
        // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã‚‚åŒæœŸã—ã¦æ›´æ–°
        showSlide(normalizedIndex);
      }
    }

    function nextModalSlide() {
      showModalSlide(currentModalSlide + 1);
    }

    function prevModalSlide() {
      showModalSlide(currentModalSlide - 1);
    }

    function showSlide(index) {
      slides.forEach((slide, i) => {
        slide.classList.toggle('carousel__slide--active', i === index);
        
        // HTML5 videoè¦ç´ ã®åˆ¶å¾¡
        const video = slide.querySelector('.carousel__video');
        const playBtn = slide.querySelector('.carousel__video-play-btn');
        
        if (video && video.dataset.videoSrc) {
          if (i === index) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ©ã‚¤ãƒ‰ã§ã¯å‹•ç”»URLã‚’è¨­å®šã€å†ç”Ÿãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const videoUrl = video.dataset.videoSrc;
            console.log('ğŸ¬ Loading main carousel video with URL:', videoUrl);
            video.src = videoUrl;
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
            video.addEventListener('loadedmetadata', () => {
              console.log('ğŸ¬ Main carousel video metadata loaded');
              video.currentTime = 0.5; // 0.5ç§’åœ°ç‚¹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
            });
            
            video.addEventListener('seeked', () => {
              console.log('ğŸ¬ Main carousel video seeked to first frame');
              video.pause(); // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ä¸€æ™‚åœæ­¢
            });
            
            if (playBtn) playBtn.style.display = 'flex';
          } else {
            // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ©ã‚¤ãƒ‰ã®å‹•ç”»ã‚’ãƒªã‚»ãƒƒãƒˆ
            video.src = '';
            video.pause();
            if (playBtn) playBtn.style.display = 'flex';
          }
        }
      });

      // ã‚µãƒ ãƒã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
      thumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('carousel__thumbnail--active', i === index);
      });

      currentSlide = index;
    }

    function nextSlide() {
      const next = (currentSlide + 1) % mediaItemsCount;
      showSlide(next);
    }

    function prevSlide() {
      const prev = (currentSlide - 1 + mediaItemsCount) % mediaItemsCount;
      showSlide(prev);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);

    // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯
    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', () => showSlide(index));
    });

    // ã‚¿ãƒƒãƒã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ï¼‰
    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 50;

    function handleMainCarouselSwipe() {
      const swipeDistance = touchEndX - touchStartX;
      if (Math.abs(swipeDistance) > minSwipeDistance) {
        if (swipeDistance > 0) {
          // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
          prevSlide();
        } else {
          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
          nextSlide();
        }
      }
    }

    const carouselContainer = document.getElementById('carousel-container');
    if (carouselContainer) {
      carouselContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      });

      carouselContainer.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].clientX;
        handleMainCarouselSwipe();
      });
    }


    // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    slides.forEach((slide, index) => {
      slide.addEventListener('click', (e) => {
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
        if (e.target.closest('.carousel__nav')) {
          console.log('Navigation button clicked, ignoring');
          return;
        }
        
        console.log('ğŸ¯ Slide clicked, current slide index:', currentSlide);
        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ©ã‚¤ãƒ‰ã«å¯¾å¿œã™ã‚‹ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
        const currentMedia = mediaItems[currentSlide];
        if (currentMedia) {
          console.log('ğŸ¯ Opening modal for media:', currentMedia.type, currentMedia.url);
          openModal(currentMedia);
        }
      });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    if (modalClose) modalClose.addEventListener('click', closeModal);
    if (modalOverlay) modalOverlay.addEventListener('click', closeModal);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    if (modalPrev) modalPrev.addEventListener('click', prevModalSlide);
    if (modalNext) modalNext.addEventListener('click', nextModalSlide);

    // ã‚¿ãƒƒãƒã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    let modalTouchStartX = 0;
    let modalTouchEndX = 0;

    function handleModalSwipe() {
      const swipeDistance = modalTouchEndX - modalTouchStartX;
      if (Math.abs(swipeDistance) > minSwipeDistance) {
        if (swipeDistance > 0) {
          // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
          prevModalSlide();
        } else {
          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
          nextModalSlide();
        }
      }
    }

    if (modalMedia) {
      modalMedia.addEventListener('touchstart', (e) => {
        modalTouchStartX = e.touches[0].clientX;
      });

      modalMedia.addEventListener('touchend', (e) => {
        modalTouchEndX = e.changedTouches[0].clientX;
        handleModalSwipe();
      });
    }
    
    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã€å·¦å³çŸ¢å°ã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.addEventListener('keydown', (e) => {
      if (modal.classList.contains('media-modal--active')) {
        if (e.key === 'Escape') {
          closeModal();
        } else if (e.key === 'ArrowLeft') {
          prevModalSlide();
        } else if (e.key === 'ArrowRight') {
          nextModalSlide();
        }
      } else {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã®ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        if (e.key === 'ArrowLeft') prevSlide();
        if (e.key === 'ArrowRight') nextSlide();
      }
    });

    // ã‚µãƒ ãƒã‚¤ãƒ«å‹•ç”»ã®æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
    function loadVideoThumbnails() {
      const thumbnailVideos = document.querySelectorAll('.carousel__thumbnail-video-element[data-video-src]');
      console.log('ğŸ¬ Found thumbnail videos:', thumbnailVideos.length);
      
      thumbnailVideos.forEach((video, index) => {
        const videoUrl = video.dataset.videoSrc;
        if (videoUrl) {
          console.log(`ğŸ¬ Loading thumbnail for video ${index}:`, videoUrl);
          
          // å‹•ç”»ã®srcã‚’è¨­å®š
          video.src = videoUrl;
          video.currentTime = 0.5; // 0.5ç§’åœ°ç‚¹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—
          
          // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã«ç§»å‹•
          video.addEventListener('loadedmetadata', () => {
            console.log(`ğŸ¬ Video ${index} metadata loaded`);
            video.currentTime = 0.5; // 0.5ç§’åœ°ç‚¹
          });
          
          // ãƒ•ãƒ¬ãƒ¼ãƒ ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ä¸€æ™‚åœæ­¢
          video.addEventListener('seeked', () => {
            console.log(`ğŸ¬ Video ${index} seeked to first frame`);
            video.pause();
          });
          
          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          video.addEventListener('error', (e) => {
            console.error(`ğŸ¬ Error loading thumbnail video ${index}:`, e);
          });
        }
      });
    }
    
    // åˆæœŸè¡¨ç¤º
    showSlide(0);
    
    // ã‚µãƒ ãƒã‚¤ãƒ«å‹•ç”»ã‚’åˆæœŸåŒ–
    setTimeout(loadVideoThumbnails, 100);
    
    console.log('âœ… All event listeners set up with HTML5 video support');
  });

  // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
  const shareButtons = document.querySelectorAll('.share-button');
  
  shareButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      const buttonType = button.className.split(' ').find(cls => cls.includes('--'));
      const currentUrl = window.location.href;
      const pageTitle = document.title;
      
      switch (buttonType) {
        case 'share-button--twitter':
          const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(pageTitle)}&url=${encodeURIComponent(currentUrl)}`;
          window.open(twitterUrl, '_blank', 'width=600,height=400');
          break;
          
        case 'share-button--line':
          const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(currentUrl)}`;
          window.open(lineUrl, '_blank', 'width=600,height=400');
          break;
          
        case 'share-button--link':
          navigator.clipboard.writeText(currentUrl).then(() => {
            // ã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const originalImg = button.innerHTML;
            button.innerHTML = `
              <div class="share-button__success">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                <span class="share-button__copied-text">Copied</span>
              </div>
            `;
            button.style.backgroundColor = '#10B981';
            
            setTimeout(() => {
              button.innerHTML = originalImg;
              button.style.backgroundColor = '#6B7280';
            }, 2000);
          }).catch(() => {
            prompt('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', currentUrl);
          });
          break;
      }
    });
  });
</script>

