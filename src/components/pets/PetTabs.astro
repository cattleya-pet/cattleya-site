---
import './PetTabs.scss';

interface Props {
  activeTab: string;
}

const { activeTab } = Astro.props;
const tabs = [
  { id: 'all', label: 'すべて' },
  { id: 'dog', label: '子犬' },
  { id: 'cat', label: '子猫' }
];
---

<div class="pet-tabs">
  {tabs.map(tab => (
    <button
      type="button"
      data-tab={tab.id}
      class:list={[
        'pet-tabs__item',
        { 'pet-tabs__item--active': activeTab === tab.id }
      ]}
    >
      <span class="pet-tabs__label">{tab.label}</span>
      <span class="pet-tabs__arrow">▼</span>
    </button>
  ))}
</div>

<script>
  import { getGoogleDriveImageUrl } from '../../lib/utils/image';
  import { formatDate } from '../../lib/utils/date';

  const tabButtons = document.querySelectorAll('.pet-tabs__item');
  const petsGrid = document.querySelector('.pets-grid');
  const allPets = JSON.parse(petsGrid?.dataset.allPets || '[]');
  const dogs = JSON.parse(petsGrid?.dataset.dogs || '[]');
  const cats = JSON.parse(petsGrid?.dataset.cats || '[]');

  tabButtons.forEach(button => {
    button.addEventListener('click', async () => {
      if (button.classList.contains('pet-tabs__item--active')) return; // 既にアクティブな場合は何もしない
      
      tabButtons.forEach(btn => btn.classList.remove('pet-tabs__item--active'));
      button.classList.add('pet-tabs__item--active');

      const selectedTab = button.dataset.tab;
      
      // タブ変更イベントを発行
      document.dispatchEvent(new CustomEvent('tabChanged', { 
        detail: { tab: selectedTab } 
      }));
      
      let currentPets = [];
      
      if (selectedTab === 'all') {
        currentPets = allPets; // 既存の混合18匹
      } else if (selectedTab === 'dog') {
        currentPets = dogs; // 既存の犬18匹
      } else if (selectedTab === 'cat') {
        currentPets = cats; // 既存の猫18匹
      }

      if (petsGrid) {
        petsGrid.innerHTML = currentPets.map(pet => `
          <div class="pet-card" data-animal-type="${pet.animalType}">
            <div class="pet-card__inner">
              <div class="pet-card__image-container">
                <img
                  class="pet-card__image"
                  src="${getGoogleDriveImageUrl(pet.imageUrl01, 600, 600)}"
                  alt="${pet.breedTypeJa}の写真"
                  loading="lazy"
                  width="600"
                  height="600"
                  onerror="this.src='/src/assets/images/img_loading-pet-image-01.webp'"
                />
              </div>
              <div class="pet-card__info">
                <h3 class="pet-card__title">
                  ${pet.breedTypeJa}
                  ${pet.gender === '男の子' ? '<span class="pet-card__gender male"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2M21 9V7L15 1H5C3.9 1 3 1.9 3 3V21C3 22.1 3.9 23 5 23H19C20.1 23 21 22.1 21 21V9H21Z"/></svg></span>' : ''}
                  ${pet.gender === '女の子' ? '<span class="pet-card__gender female"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4A4 4 0 0 1 16 8A4 4 0 0 1 12 12A4 4 0 0 1 8 8A4 4 0 0 1 12 4M12 14C16.42 14 20 15.79 20 18V20H4V18C4 15.79 7.58 14 12 14Z"/></svg></span>' : ''}
                </h3>
                <div class="pet-card__details">
                  <p class="pet-card__detail-item">色：${pet.color}</p>
                  <p class="pet-card__detail-item">誕生日：${formatDate(pet.birthday)}</p>
                  <p class="pet-card__detail-item">店舗：${pet.storeName}</p>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    });
  });
</script>