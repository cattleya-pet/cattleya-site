---
interface Props {
  petId: string;
  storeLine?: string;
}

const { petId, storeLine } = Astro.props;

// ペットIDから先頭の0を除去
const displayPetId = petId.replace(/^0+/, '') || petId;

// コピー用のテキスト内容
const inquiryText = `①（こちらにお客様のフルネームをご入力ください）
②No.${displayPetId}
③HP`;

// LINE URLの生成
const lineUrl = storeLine ? `https://lin.ee/${storeLine}` : '#';
---

<!-- モーダルオーバーレイ -->
<div id="line-inquiry-modal" class="line-modal-overlay">
  <div class="line-modal">
    <div class="line-modal__header">
      <h3 class="line-modal__title">LINEでお問い合わせ</h3>
      <button class="line-modal__close" aria-label="閉じる">&times;</button>
    </div>
    
    <div class="line-modal__body">
      <p class="line-modal__instruction">
        下記の内容をコピーし、店舗LINEの<br>
        メッセージ欄に貼り付けしてください。
      </p>
      
      <div class="line-modal__copy-section">
        <button id="copy-button" class="line-modal__copy-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" aria-hidden="true">
            <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/>
          </svg>
          Copy
        </button>
        <div class="line-modal__text-box">
          <pre id="inquiry-text">{inquiryText}</pre>
        </div>
      </div>
      
      <div class="line-modal__copy-status" id="copy-status"></div>
    </div>
    
    <div class="line-modal__footer">
      <a 
        href={lineUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="line-modal__line-btn"
      >
        店舗LINEへ
      </a>
      <button class="line-modal__cancel-btn">閉じる</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('line-inquiry-modal');
    const closeBtn = document.querySelector('.line-modal__close');
    const cancelBtn = document.querySelector('.line-modal__cancel-btn');
    const copyBtn = document.getElementById('copy-button');
    const inquiryText = document.getElementById('inquiry-text');
    const copyStatus = document.getElementById('copy-status');
    
    // モーダルを開く関数
    window.openLineInquiryModal = function() {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };
    
    // モーダルを閉じる関数
    function closeModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      copyStatus.textContent = '';
    }
    
    // 閉じるボタンのイベント
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    
    // オーバーレイクリックで閉じる
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });
    
    // コピー機能
    copyBtn.addEventListener('click', async function() {
      try {
        await navigator.clipboard.writeText(inquiryText.textContent);
        copyStatus.textContent = 'コピーしました！';
        copyStatus.className = 'line-modal__copy-status success';
        
        // メッセージは消さない
      } catch (err) {
        // フォールバック：テキストエリアを使用
        const textArea = document.createElement('textarea');
        textArea.value = inquiryText.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        copyStatus.textContent = 'コピーしました！';
        copyStatus.className = 'line-modal__copy-status success';
        
        // メッセージは消さない
      }
    });
  });
</script>